#!/bin/sh
set -e

echo "=== 8ppoi ãƒ™ãƒ³ãƒ€ãƒ¼åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ==="

# 1ï¸âƒ£ GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ›
read -p "GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›: " VENDOR_ID
if [ -z "$VENDOR_ID" ]; then
  echo "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚"
  exit 1
fi

# 2ï¸âƒ£ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå­˜åœ¨ç¢ºèª
echo "GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèªä¸­..."
if ! curl -s https://api.github.com/users/$VENDOR_ID | grep -q '"login":'; then
  echo "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ $VENDOR_ID ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚"
  exit 1
fi
echo "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª OK âœ…"

# 3ï¸âƒ£ ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªä½œæˆæ¡ˆå†…
echo ""
echo "æ¬¡ã« GitHub ã§ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„:"
echo "  $VENDOR_ID/8ppoi-vendor ã‚’ public ãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦ä½œæˆ"
echo "ä½œæˆãŒçµ‚ã‚ã£ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„"
read dummy

# 4ï¸âƒ£ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨åˆæœŸåŒ–
TARGET_DIR="./vendors/$VENDOR_ID"
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# .gitignore ä½œæˆ
cat > .gitignore <<EOF
# ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç„¡è¦–
/cartridges
EOF

# GitHubã‹ã‚‰ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’å–å¾—
AVATAR_URL=$(curl -s https://api.github.com/users/$VENDOR_ID | grep -Po '"avatar_url": "\K[^"]+')
if [ -n "$AVATAR_URL" ]; then
  # æ‹¡å¼µå­åˆ¤å®š
  EXT=$(curl -sI "$AVATAR_URL" | grep -i '^Content-Type:' | awk '{print $2}' | tr -d '\r' | sed 's|image/||')
  [ -z "$EXT" ] && EXT="jpg"
  
  curl -sL "$AVATAR_URL" -o "avatar.$EXT"
  echo "avatar.$EXT ã‚’ GitHub ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸ âœ…"
else
  echo "ã‚¢ãƒã‚¿ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
fi

# avataræ‹¡å¼µå­ã«åˆã‚ã›ã¦ meta.json ä½œæˆ
META_FILE="meta.json"
AVATAR_FILE="avatar.$EXT"

cat > "$META_FILE" <<EOF
{
  "name": "$VENDOR_ID",
  "avatar": "$AVATAR_FILE",
  "description": "ç§ã®åå‰ã¯ $VENDOR_ID ã§ã™ã€‚"
}
EOF

echo "meta.json ã‚’ç”Ÿæˆã—ã¾ã—ãŸ âœ…"

git init
git remote add origin git@github.com:$VENDOR_ID/8ppoi-vendor.git

# 5ï¸âƒ£ ç·¨é›†å¾Œã‚³ãƒŸãƒƒãƒˆãƒ»push
echo ""
echo "meta.json ã®ç·¨é›†ãŒçµ‚ã‚ã£ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„"
read dummy

git add -A
git commit --allow-empty-message -m ""
git push -u origin main

echo ""
echo "âœ… ãƒ™ãƒ³ãƒ€ãƒ¼åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
echo "ãƒªãƒ¢ãƒ¼ãƒˆ: git@github.com:$VENDOR_ID/8ppoi-vendor.git"
echo "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸: https://8ppoi.com/vendors/$VENDOR_ID/"
echo "ðŸŽ‰ ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ“ãƒ¥ãƒ¼ãŠã‚ã§ã¨ã†ï¼ã“ã‚Œã§ã‚ãªãŸã‚‚å…¬å¼8ppoiãƒ™ãƒ³ãƒ€ãƒ¼ã§ã™ âœ¨"
