#!/bin/sh
set -e

echo "=== 8ppoi ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ==="

# 1ï¸âƒ£ GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ›
read -p "GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›: " VENDOR_ID
if [ -z "$VENDOR_ID" ]; then
  echo "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚"
  exit 1
fi

# 2ï¸âƒ£ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå­˜åœ¨ç¢ºèª
echo "GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèªä¸­..."
if ! curl -s https://api.github.com/users/$VENDOR_ID | grep -q '"login":'; then
  echo "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ $VENDOR_ID ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚"
  exit 1
fi
echo "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª OK âœ…"

# 1ï¸âƒ£ ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸IDå…¥åŠ›
read -p "ä½œæˆã™ã‚‹ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸ã®IDã‚’å…¥åŠ›: " CARTRIDGE_ID
if [ -z "$CARTRIDGE_ID" ]; then
  echo "ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸IDãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚"
  exit 1
fi

# 3ï¸âƒ£ ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªä½œæˆæ¡ˆå†…
echo ""
echo "æ¬¡ã« GitHub ã§ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„:"
echo "  $VENDOR_ID/8ppoi-cartridge-$CARTRIDGE_ID ã‚’ public ãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦ä½œæˆ"
echo "ä½œæˆãŒçµ‚ã‚ã£ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„"
read dummy

# 4ï¸âƒ£ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨åˆæœŸåŒ–
TARGET_DIR="./vendors/$VENDOR_ID/cartridges/$CARTRIDGE_ID"
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# GitHubã‹ã‚‰ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’å–å¾—
AVATAR_URL=$(curl -s https://api.github.com/users/$VENDOR_ID | grep -Po '"avatar_url": "\K[^"]+')
if [ -n "$AVATAR_URL" ]; then
  # æ‹¡å¼µå­åˆ¤å®š
  EXT=$(curl -sI "$AVATAR_URL" | grep -i '^Content-Type:' | awk '{print $2}' | tr -d '\r' | sed 's|image/||')
  [ -z "$EXT" ] && EXT="jpg"
  
  curl -sL "$AVATAR_URL" -o "artwork.$EXT"
  echo "artwork.$EXT ã‚’ GitHub ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸ âœ…"
else
  echo "ã‚¢ãƒã‚¿ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
fi

# artworkæ‹¡å¼µå­ã«åˆã‚ã›ã¦ meta.json ä½œæˆ
META_FILE="meta.json"
ARTWORK_FILE="artwork.$EXT"

cat > "$META_FILE" <<EOF
{
  "consoleVersion": "1.0.0-alpha.1",
  "name": "$CARTRIDGE_ID",
  "artwork": "$ARTWORK_FILE",
  "description": "B0ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯Zï¼‰ã¨B1ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯Xï¼‰ã‚’æŠ¼ã™ã¨ã€è‰²ã®ä»˜ã„ãŸæ–‡å­—ãŒè¸Šã‚Šã¾ã™ðŸŽµ"
}
EOF

echo "meta.json ã‚’ç”Ÿæˆã—ã¾ã—ãŸ âœ…"

# Cartridge.js ä½œæˆ
CARTRIDGE_FILE="Cartridge.js"

cat > "$CARTRIDGE_FILE" <<EOF
export class Cartridge {
  /** ãƒªã‚»ãƒƒãƒˆå‡¦ç† */
  static onReset({ pads, speakers, screens }) {
    this.pads = pads;
    this.speakers = speakers;
    this.screens = screens;

    this.screens[0].setViewBox(0, 0, 64, 48);

    this.msg0 = this.screens[0].addText("$CARTRIDGE_ID", {
      x: 2,
      y: 32,
      colorIds: [null, Math.floor(Math.random() * 7) + 9],
    });

    this.msg1 = this.screens[0].addText("$VENDOR_ID", {
      x: 2,
      y: 40,
      colorIds: [null, Math.floor(Math.random() * 7) + 1],
    });
  }

  /** ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç† */
  static onFrame() {
    if (this.sfx?.ended) {
      delete this.sfx;
    }
    if (this.pads[0].buttons.b0.pressed) {
      this.msg0.y -= 2;
      if (!this.sfx) {
        this.sfx = this.speakers[0].play([
          [
            { noteNumber: [0, 4, 7, 11, 12][Math.floor(Math.random() * 5)], duration: 8 },
          ]
        ]);
      }
    }
    this.msg0.y += 1;
    this.msg0.y = Math.min(this.msg0.y, 32);

    if (this.pads[0].buttons.b1.pressed) {
      this.msg1.y -= 2;
      if (!this.sfx) {
        this.sfx = this.speakers[0].play([
          [
            { noteNumber: [0, 4, 7, 10, 12][Math.floor(Math.random() * 5)] - 5, duration: 8 },
          ]
        ]);
      }
    }
    this.msg1.y += 1;
    this.msg1.y = Math.min(this.msg1.y, 40);
  }
}
EOF

echo "Cartridge.js ã‚’ç”Ÿæˆã—ã¾ã—ãŸ âœ…"

git init
git remote add origin git@github.com:$VENDOR_ID/8ppoi-cartridge-$CARTRIDGE_ID.git

# 5ï¸âƒ£ ç·¨é›†å¾Œã‚³ãƒŸãƒƒãƒˆãƒ»push
echo ""
echo "meta.json ã®ç·¨é›†ãŒçµ‚ã‚ã£ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„"
read dummy

git add -A
git commit --allow-empty-message -m ""
git push -u origin main

echo ""
echo "âœ… ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
echo "ãƒªãƒ¢ãƒ¼ãƒˆ: git@github.com:$VENDOR_ID/8ppoi-cartridge-$CARTRIDGE_ID.git"
echo "ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸ãƒšãƒ¼ã‚¸: https://8ppoi.com/vendors/$VENDOR_ID/cartridges/$CARTRIDGE_ID"
echo "ðŸŽ‰ ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸ã®å…¬é–‹ãŠã‚ã§ã¨ã†ï¼âœ¨"
echo "ã“ã‚Œã§ã‚ãªãŸã®ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸ãŒ8ppoiã§éŠã¹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼"
echo "ã¿ã‚“ãªã«éŠã‚“ã§ã‚‚ã‚‰ã£ã¦æ¥½ã—ã‚“ã§ã‚‚ã‚‰ãŠã†ðŸ’–"
